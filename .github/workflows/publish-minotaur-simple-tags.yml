name: Publish alpha

on:
  push:
    tags: ['alpha', 'beta', 'release']

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-java@v4
        with: { distribution: 'temurin', java-version: '21' }

      - uses: gradle/actions/setup-gradle@v4

      - id: ch
        name: Parse channel
        shell: bash
        run: |
          case "${GITHUB_REF_NAME}" in
            alpha|beta|release) echo "channel=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT ;;
            *) echo "Unsupported tag"; exit 1 ;;
          esac

      - id: mc
        name: Detect Minecraft version
        shell: bash
        run: |
          set -euo pipefail
          MC=""
          if [[ -f gradle.properties ]]; then
            MC="$(sed -nE 's/^[[:space:]]*minecraft_version[[:space:]]*=[[:space:]]*([0-9][0-9.]*)/\1/p' gradle.properties | head -n1 || true)"
          fi
          [[ -n "$MC" ]] || { echo "MC version not found"; exit 1; }
          echo "mc=$MC" >> $GITHUB_OUTPUT
          echo "Detected MC=$MC"

      - id: ver
        name: Compute next version & push permanent tag
        shell: bash
        run: |
          set -euo pipefail
          CH="${{ steps.ch.outputs.channel }}"
          MC="${{ steps.mc.outputs.mc }}"

          LAST_RELEASE="$(git tag --list "v[0-9]*+mc${MC}" --sort=-v:refname \
                          | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+\+mc'"${MC}"'$' \
                          | head -n1 || true)"
          if [[ -z "$LAST_RELEASE" ]]; then
            MA=0; MI=1; PA=0
          else
            V="${LAST_RELEASE%%+mc*}"; V="${V#v}"
            IFS=. read -r MA MI PA <<< "$V"
          fi

          BASE_NEXT="${MA}.${MI}.$((PA+1))"

          make_pre() {
            local kind="$1"
            local last="$(git tag --list "v${BASE_NEXT}-${kind}.*+mc${MC}" --sort=-v:refname | head -n1 || true)"
            if [[ -z "$last" ]]; then echo 1; else
              echo $(( $(sed -nE 's/^v[0-9]+\.[0-9]+\.[0-9]+-'${kind}'\.([0-9]+)\+mc.+/\1/p' <<<"$last") + 1 ))
            fi
          }

          if [[ "$CH" == "release" ]]; then
            VERSION="${BASE_NEXT}"
          elif [[ "$CH" == "beta" ]]; then
            VERSION="${BASE_NEXT}-beta.$(make_pre beta)"
          else
            VERSION="${BASE_NEXT}-alpha.$(make_pre alpha)"
          fi

          PERM_TAG="v${VERSION}+mc${MC}"
          echo "version=$VERSION"   >> $GITHUB_OUTPUT
          echo "perm_tag=$PERM_TAG" >> $GITHUB_OUTPUT

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$PERM_TAG" -m "Auto ${CH} for MC ${MC}"
          git push origin "$PERM_TAG"

      - name: Build (override mod_version at CI)
        run: ./gradlew clean build --stacktrace -Pmod_version=${{ steps.ver.outputs.version }}

      - name: Publish to Modrinth & GitHub (mc-publish)
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          # --- Modrinth ---
          modrinth-id: jWHdryID
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          # --- „Éê„Éº„Ç∏„Éß„É≥Ë°®Ë®ò„Éª„ÉÅ„É£„É≥„Éç„É´ ---
          version: ${{ steps.ver.outputs.perm_tag }}          # Ë°®Á§∫Âêç„ÅØÊÅí‰πÖ„Çø„Ç∞ÊñáÂ≠óÂàóÔºàÂ•Ω„Åø„Åß v „Å™„Åó„Å´„Åó„Å¶„ÇÇOKÔºâ
          version-type: ${{ steps.ch.outputs.channel }}       # release | beta | alpha

          loaders: fabric
          game-versions: ${{ steps.mc.outputs.mc }}
          java: 21

          # mc-publish „ÅØËá™Âãï„Éì„É´„Éâ„ÇÇ„Åß„Åç„Åæ„Åô„Åå„ÄÅ„Åì„Åì„Åß„ÅØÁîüÊàêÊ∏à„ÅøJAR„ÇíÊ∏°„Åó„Å¶Á¢∫ÂÆü„Å´ÂÖ¨Èñã
          files: build/libs/*[!sources][!dev].jar

          # --- GitHub Release ÈÄ£Êê∫ÔºàÂêåÂêç„Çø„Ç∞Ôºâ ---
          github-token: ${{ secrets.GITHUB_TOKEN }}
          github-tag: ${{ steps.ver.outputs.perm_tag }}
          github-prerelease: ${{ steps.ch.outputs.channel != 'release' }}
          github-draft: false

      - name: Notify Discord (all channels)
        if: ${{ success() }}   # Â§±ÊïóÊôÇ„ÅØÈÄÅ„Çâ„Å™„ÅÑ„ÄÇÈÄÅ„Çã„Å™„Çâ always() „Å´Â§âÊõ¥
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          CHANNEL:     ${{ steps.ch.outputs.channel }}   # alpha | beta | release
          VERSION_TAG: ${{ steps.ver.outputs.perm_tag }} # ‰æã: v1.2.3-beta.4+mc1.21.8
          MC_VERSION:  ${{ steps.mc.outputs.mc }}        # ‰æã: 1.21.8
          MODRINTH_ID: YOUR_MODRINTH_PROJECT_ID          # ‚ÜêËá™ÂàÜ„ÅÆ Modrinth Project ID „Å´ÁΩÆÊèõ
        run: |
          set -euo pipefail

          # ---- „É°„ÇøÊÉÖÂ†± ----
          REPO="${GITHUB_REPOSITORY}"
          SHA_SHORT="$(git rev-parse --short HEAD)"
          NOW_UTC="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          GH_RELEASE_URL="https://github.com/${REPO}/releases/tag/${VERSION_TAG}"
          MODRINTH_VER_URL="https://modrinth.com/mod/${MODRINTH_ID}/version/${VERSION_TAG}"

          # ---- „ÉÅ„É£„É≥„Éç„É´Âà•„ÅÆÂ§ñË¶≥ÔºàËâ≤„Éª„Çø„Ç§„Éà„É´„Ç¢„Ç§„Ç≥„É≥„Éªpre-releaseË°®Ë®òÔºâ----
          # Discord „ÅÆ color „ÅØ 24bit Êï¥Êï∞Ôºà‰æãÔºö0x2ECC71 = 3066993Ôºâ
          case "${CHANNEL}" in
            alpha)
              TITLE_PREFIX="üî¨ Alpha"
              COLOR=10181046   # 0x9B59B6 (Purple)
              PRERELEASE_LABEL="Pre-release"
              ;;
            beta)
              TITLE_PREFIX="üß™ Beta"
              COLOR=3447003    # 0x3498DB (Blue)
              PRERELEASE_LABEL="Pre-release"
              ;;
            release)
              TITLE_PREFIX="üéâ Release"
              COLOR=3066993    # 0x2ECC71 (Green)
              PRERELEASE_LABEL="Stable"
              ;;
            *)
              TITLE_PREFIX="üì¶ Build"
              COLOR=15158332   # 0xE74C3C (Red) fallback
              PRERELEASE_LABEL="Build"
              ;;
          esac

          # ---- CHANGELOG ÊäúÁ≤ãÔºàÈï∑„Åô„Åé„Çã„Å®„Ç®„É©„Éº„Å´„Å™„Çã„ÅÆ„ÅßÂÖàÈ†≠60Ë°å„ÇíÁ∞°ÊòìÊäúÁ≤ãÔºâ----
          CHANGELOG_SNIP="$(sed -n '1,60p' CHANGELOG.md 2>/dev/null || true)"
          if [ -z "${CHANGELOG_SNIP}" ]; then
            CHANGELOG_SNIP="Released for Minecraft **${MC_VERSION}**."
          fi
          # JSON ÊñáÂ≠óÂàóÁî®„Å´ÊúÄ‰ΩéÈôê„ÅÆ„Ç®„Çπ„Ç±„Éº„Éó
          CHANGELOG_SNIP="${CHANGELOG_SNIP//\\/\\\\}"
          CHANGELOG_SNIP="${CHANGELOG_SNIP//\"/\\\"}"

          # ---- Embed Êú¨ÊñáÔºà„É™„É≥„ÇØ„Éú„Çø„É≥‰ªò„ÅçÔºâ----
          read -r -d '' JSON <<EOF || true
          {
            "username": "StreamTweaks Release Bot",
            "embeds": [
              {
                "title": "${TITLE_PREFIX}: ${VERSION_TAG}",
                "url": "${GH_RELEASE_URL}",
                "description": "${CHANGELOG_SNIP}",
                "color": ${COLOR},
                "fields": [
                  { "name": "Channel",   "value": "${CHANNEL}",       "inline": true },
                  { "name": "Stability", "value": "${PRERELEASE_LABEL}", "inline": true },
                  { "name": "Minecraft", "value": "${MC_VERSION}",    "inline": true },
                  { "name": "Modrinth",  "value": "${MODRINTH_VER_URL}" },
                  { "name": "GitHub",    "value": "${GH_RELEASE_URL}" }
                ],
                "footer": { "text": "Commit ${SHA_SHORT} ‚Ä¢ ${REPO}" },
                "timestamp": "${NOW_UTC}"
              }
            ],
            "components": [
              {
                "type": 1,
                "components": [
                  { "type": 2, "style": 5, "label": "View on Modrinth", "url": "${MODRINTH_VER_URL}" },
                  { "type": 2, "style": 5, "label": "GitHub Release",   "url": "${GH_RELEASE_URL}" }
                ]
              }
            ]
          }
          EOF

          curl -sS -X POST -H "Content-Type: application/json" \
            -d "${JSON}" "$WEBHOOK_URL"


      - name: Delete trigger tag (alpha/beta/release)
        if: always()
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git push origin :refs/tags/${{ steps.ch.outputs.channel }}